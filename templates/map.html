{% extends "navigation.html" %}
{% load staticfiles %}

{% block extra_head %}
    <script>L_PREFER_CANVAS = true;</script>


    {#  Remote leaflet  #}
    {#    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css"/>#}
    {#    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>#}

    {#  local leaflet  #}
    <script type="text/javascript" src="{% static 'leafletjs.com/leaflet-0.7.3/leaflet.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'leafletjs.com/leaflet-0.7.3/leaflet.css' %}" />


    {#  remote mapbox - use this is leaflet, probably not both  #}
    {#    <script src='https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.js'></script>#}
    {#    <link href='https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.css' rel='stylesheet' />#}


    {#  remote mapbox draw buttons  #}
    {#    <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.2/leaflet.draw.js'></script>#}
    {#    <link href='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.2/leaflet.draw.css' rel='stylesheet' />#}


    {#  local mapbox draw buttons  #}
    <link rel="stylesheet" type="text/css" href="{% static 'mapbox.js/plugins/Leaflet.draw-master/dist/leaflet.draw.css' %}"/>
    <script type="text/javascript" src="{% static 'mapbox.js/plugins/Leaflet.draw-master/dist/leaflet.draw.js' %}"></script>

    {#    <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-geodesy/v0.1.0/leaflet-geodesy.js'></script>#}
    <script type="text/javascript" src="{% static 'mapbox.js/plugins/leaflet-geodesy/v0.1.0/leaflet-geodesy.js' %}"></script>

    {#    <script src="http://code.jquerygeo.com/jquery.geo-1.0.0-b2.min.js"></script>#}
    <script type="text/javascript" src="{% static 'code.jquerygeo.com/jquery.geo-1.0.0-b2.min.js' %}"></script>

    <script type="text/javascript" src="{% static 'jscoord-1.1.1.js' %}"></script>

    {#    <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-image/v0.0.4/leaflet-image.js'></script>#}
    <script type="text/javascript" src="{% static 'mapbox.js/plugins/leaflet-image/v0.0.4/leaflet-image.js' %}"></script>

    <style>
        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        .info h4 {
            margin: 0 0 5px;
            color: #777;
        }

        .legend {
            text-align: left;
            line-height: 18px;
            color: #555;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
    </style>

{% endblock %}

{% block nav_extras %}
    <li>
        <a href="#"><i class="fa fa-sitemap fa-fw"></i> Map layers<span class="fa arrow"></span></a>
        <ul class="nav nav-second-level">
            <li>
                <a href="#"> Add<span class="fa arrow"></span></a>
                <ul id="layer_list" class="nav nav-third-level">
                    <li>
                        <a href="#" id="new_annotation"><i class="fa fa-map-marker fa-fw"></i> New Annotation</a>
                    </li>
                    <li>
                        <a href="#"><i class="fa fa-map-marker fa-fw"></i> New Layer</a>
                    </li>
                </ul>
            </li>
        </ul>
    </li>
{% endblock %}

{% block content %}
    <script>

        $(document).ready(function () {

            {#            below is map stuff #}
            var wkt = '';
            var center_lat_lng = '';
            var geojson = '';
            var geoJson_area_km2 = '';

            var map_height = window.innerHeight;
            var header_height = $('.navbar').height();

            $('#map_div').css({height: map_height - header_height - 5});

            var map = L.map('map_div').setView([51.53181, -3.24687], 10);

            L.tileLayer('http://i7.cscloud.cf.ac.uk/osmcarto/{z}/{x}/{y}.png?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
                maxZoom: 15,
                id: 'your.mapbox.project.id',
                accessToken: 'your.mapbox.public.access.token'
            }).addTo(map);

            var info = L.control();

            info.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
                this.update();
                return this._div;
            };

// method that we will use to update the control based on feature properties passed
            info.update = function (props) {
                this._div.innerHTML = '<div style="min-height: 10%"><h4>Region Response Rate</h4>' +  (props ?
                '<b>' + props.area_name + '</b><br />' + props.response_rate + ' people / mi<sup>2</sup>'
                        : 'Hover over a region') + '<h4></h4></div>';
            };

            info.addTo(map);

            var geojson;
            function resetHighlight(e) {
                geojson.resetStyle(e.target);
                info.update();
            }

            function highlightFeature(e) {
                var layer = e.target;
                layer.setStyle({
                    weight: 5,
                    color: '#666',
                    dashArray: '',
                    fillOpacity: 0.7
                });
                if (!L.Browser.ie && !L.Browser.opera) {
                    layer.bringToFront();
                }
                info.update(layer.feature.properties);
            }

            var cupcakeTiles = L.tileLayer('http://i7.cscloud.cf.ac.uk/osmcarto/{z}/{x}/{y}.png', {
                maxZoom: 15
            });

            function getColor(d) {
                return d > 80 ? '#800026' :
                        d > 75  ? '#BD0026' :
                                d > 70  ? '#E31A1C' :
                                        d > 65  ? '#FC4E2A' :
                                                d > 60   ? '#FD8D3C' :
                                                        d > 50   ? '#FEB24C' :
                                                                d > 40   ? '#FED976' :
                                                                        '#FFEDA0';
            }

            $.getJSON("{% url 'get_geojson' %}", function(data) {
                console.log(data['properties']['name']);
                var new_button = '<li><a href="#"><i class="fa fa-dashboard fa-fw"></i> '
                        + data['properties']['name'] + '</a></li>';
                $('#layer_list').append(new_button);

                geojson = L.geoJson(data, {
                    onEachFeature: function (feature, layer) {
                        layer.bindPopup(feature.properties.area_name + '<br>' + feature.properties.response_rate + '%');
                        layer.on({
                            mouseover: highlightFeature,
                            mouseout: resetHighlight,
{#                            click: zoomToFeature#}
                        });
                    },
                    style: function(feature) {
                        return {
                            fillColor: getColor(feature.properties.response_rate),
                            weight: 2,
                            opacity: 1,
                            color: 'white',
                            dashArray: '3',
                            fillOpacity: 0.7
                        };
                    }

                });
                {#                                var map = L.map('cupcake-map').fitBounds(geojson.getBounds());#}
                cupcakeTiles.addTo(map);
                geojson.addTo(map);
            });

            {#            function onMapClick(e) {#}
            {#                var popup = L.marker()#}
            {#                        .setLatLng(e.latlng)#}
            {#                        .setContent(e.latlng)#}
            {#                        .openOn(map);#}
            {#                leafletImage(map, doImage)#}
            {#            }#}

            {#            map.on('click', onMapClick);#}

            var featureGroup = L.featureGroup().addTo(map);

            var drawControl = new L.Control.Draw({
                edit: {
                    featureGroup: featureGroup
                },
                draw: {
                    polygon: true,
                    polyline: false,
                    rectangle: {
                        shapeOptions : {
                            color : '#888888'
                        }
                    },
                    circle: false,
                    marker: false
                }
            }).addTo(map);

            map.on('draw:created', showPolygonArea);
            map.on('draw:edited', showPolygonAreaEdited);

            function convertPolygonToOS(shape_geojson){

                var new_coordinates = [];
                var new_geometry = {
                    "type": "Polygon",
                    "coordinates": [[]]
                };

                for (var a = 0; a < shape_geojson['geometry']['coordinates'][0].length; a++) {
                    var ll2 = new LatLng(shape_geojson['geometry']['coordinates'][0][a][1],
                            shape_geojson['geometry']['coordinates'][0][a][0]);
                    var os2 = ll2.toOSRef();
                    new_coordinates.push([os2.easting, os2.northing]);
                }

                new_geometry['coordinates'] = [new_coordinates];

                return new_geometry

            }
            function showPolygonAreaEdited(e) {
                e.layers.eachLayer(function(layer) {
                    showPolygonArea({ layer: layer });
                });
            }

            function showPolygonArea(e) {

                featureGroup.clearLayers();
                featureGroup.addLayer(e.layer);

                geoJson_area_km2 = (LGeo.area(e.layer) / 1000000).toFixed(2);
                e.layer.bindPopup(geoJson_area_km2 + ' km<sup>2</sup>');
                e.layer.openPopup();

                geojson = e.layer.toGeoJSON();
                var new_geojson = convertPolygonToOS(geojson);
                wkt = $.geo.WKT.stringify(new_geojson);

                map.fitBounds(featureGroup.getBounds());
                center_lat_lng = featureGroup.getBounds().getCenter();
                map.addOneTimeEventListener('viewreset', function() {
                    setTimeout(function(){
                        leafletImage(map, doImage);
                    }, 1000);
                });
            }

            var most_recent_search_png = '';
            function doImage(err, canvas) {
                {#                var snapshot = document.getElementById('snapshot');#}

                var img = document.createElement('img');
                var dimensions = map.getSize();
                img.width = dimensions.x;
                img.height = dimensions.y;
                most_recent_search_png = canvas.toDataURL();
                img.src = most_recent_search_png;
                {#                img.style.width = '100%';#}
                {#                snapshot.innerHTML = '';#}
                {#                snapshot.appendChild(img);#}

                $.ajax({
                    url: '/spatial_search',
                    type: 'POST',
                    data: {
                        geography: wkt,
                        geojson: geojson,
                        centre_lat_lng: [center_lat_lng.lat, center_lat_lng.lng],
                        geo_area_km2: geoJson_area_km2,
                        start: 0,
                        limit: 15,
                        type: "Qual",
                        uid_only: true,
                        image_png: most_recent_search_png
                    },
                    success: function(data) {
                        if (data['uid']) {
                            {#                            console.log("{% url 'tables' %}?search_id=" + data['uid']);#}
                            {#                            var snapshot = document.getElementById('output');#}
                            {#                            snapshot.innerHTML = "{% url 'tables' %}?search_id=" + data['uid'];#}

                            setTimeout(function(){
                                window.location = "{% url 'tables' %}?search_id=" + data['uid'];
                            }, 1000);
                        }
                    }
                });
            }

            String.prototype.format = function() {
                var formatted = this;
                for (var i = 0; i < arguments.length; i++) {
                    var regexp = new RegExp('\\{'+i+'\\}', 'gi');
                    formatted = formatted.replace(regexp, arguments[i]);
                }
                return formatted;
            };

            $("#menu-toggle").click(function(e) {
                e.preventDefault();
                $("#wrapper").toggleClass("toggled");
            });
        });

    </script>


    <div id="output"></div>
    <div id="map_div" style="height: 180px;"></div>

    <div class="well">
        <h4>DataTables Usage Information</h4>
        <div id="snapshot"></div>
    </div>


{% endblock %}

